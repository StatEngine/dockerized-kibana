FROM alpine:3.7 as builder

RUN apk add --no-cache zip

ARG THEME=nfors
ENV THEME=${THEME}

COPY kibana /kibana

COPY themes/${THEME}/styles/custom_style.less /kibana/custom_style/public/less/custom_style.less

RUN zip -r /custom_style.zip kibana

FROM docker.elastic.co/kibana/kibana:7.5.1

ARG ROR_VERSION=readonlyrest_kbn_enterprise-1.19.0_es7.5.1.zip
ENV ROR_VERSION=${ROR_VERSION}

ARG THEME=nfors
ENV THEME=${THEME}

ARG COOKIE_PASS=pv2PXhd5M6ILsa9WQw1wZ3u4QMSzrUjNMuBUV23pNy1nW
ENV COOKIE_PASS=${COOKIE_PASS}

ENV SERVER_HOST=0.0.0.0
ENV SERVER_BASEPATH=/_plugin/kibana
ENV ELASTICSEARCH_URI=http://docker.for.mac.localhost:9200
ENV ELASTICSEARCH_KIBANA_USER=kibana
ENV ELASTICSEARCH_KIBANA_PASSWORD=kibana
ENV REPORTING_KEY=abc123
ENV ROR_CUSTOM_LOGOUT_LINK=http://localhost:3000/workspaces

# Custom plugins
COPY ${ROR_VERSION} /usr/share/kibana/${ROR_VERSION}

# Custom favicons
COPY themes/${THEME}/favicons/* /usr/share/kibana/src/legacy/ui/public/assets/favicons/
COPY themes/${THEME}/logo.svg /usr/share/kibana/node_modules/@elastic/eui/src/components/icon/assets/logo_kibana.svg
COPY themes/${THEME}/logo.svg /usr/share/kibana/node_modules/@elastic/eui/lib/components/icon/assets/logo_kibana.svg

# Custom throbber
RUN sed -i 's/Loading Kibana/Loading Dashboard/g' /usr/share/kibana/src/legacy/ui/ui_render/views/ui_app.pug
RUN sed -i 's/image\/svg+xml.*");/image\/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNTQiIGhlaWdodD0iMTY4IiB2aWV3Qm94PSIwIDAgMTU0IDE2OCI+CiAgPGcgZmlsbD0ibm9uZSIgb3BhY2l0eT0iLjUiPgogICAgPHBhdGggZmlsbD0iI0ZFQzM0MCIgZD0iTTE0NC40MjQ5NjIsNzAuNzEzMDQzNSBDMTQ0LjQyNDk2MiwxMTEuNzIxNzM5IDEyNC4xNjA5MDEsMTEwLjQ2OTU2NSAxMjQuMTYwOTAxLDEwMS4yMTczOTEgQzEyNC4xNjA5MDEsOTEuOTY1MjE3NCAxMzMuMzUyODQ2LDg0LjggMTMzLjM1Mjg0Niw2OC4yMDg2OTU3IEMxMzMuMzUyODQ2LDM3LjM1NjUyMTcgMTEwLjE5ODg5MiwyNy41NDc4MjYxIDExMC4xOTg4OTIsNCBDMTEwLjE5ODg5Miw0IDEwNS42MDI5MiwxMS44NjA4Njk2IDEwNS42MDI5MiwyMi43MTMwNDM1IEMxMDUuNjAyOTIsMzYuMzQ3ODI2MSAxMTEuNDg3MTU4LDM5LjMwNDM0NzggMTExLjQ4NzE1OCw1Mi40ODY5NTY1IEMxMTEuNDg3MTU4LDcyLjQ4Njk1NjUgOTEuMDgzODIzOSw2OC40ODY5NTY1IDkxLjA4MzgyMzksNDYuOTU2NTIxNyBDOTAuOTQ0NTUyLDQzLjQ0MzQ3ODMgOTEuNDMyMDAzNiwzOC4zNjUyMTc0IDkxLjQzMjAwMzYsMzUuMjM0NzgyNiBDOTEuNDMyMDAzNiwxNi4xMDQzNDc4IDcxLjUxNjEyMTcsMTIuNzMwNDM0OCA3MS41MTYxMjE3LDEyLjczMDQzNDggQzcxLjUxNjEyMTcsMTIuNzMwNDM0OCA3Ni41NjQ3MjgxLDE2Ljg2OTU2NTIgNzYuNTY0NzI4MSwyNy43OTEzMDQzIEM3Ni41NjQ3MjgxLDM5LjQwODY5NTcgNjEuMDcwNzI5LDQwLjg2OTU2NTIgNjEuMDcwNzI5LDE5LjU4MjYwODcgQzYxLjA3MDcyOSw2LjMzMDQzNDc4IDYyLjY3MjM1NTksMCA2Mi42NzIzNTU5LDAgQzYyLjY3MjM1NTksMCA0OC44NDk2MTk2LDguMzEzMDQzNDggNDguODQ5NjE5NiwyMy43OTEzMDQzIEM0OC44NDk2MTk2LDM1LjE2NTIxNzQgNTIuNTQwMzI1LDQwLjUyMTczOTEgNTIuNTQwMzI1LDQ2LjY0MzQ3ODMgQzUyLjU0MDMyNSw1My43MDQzNDc4IDQ4Ljg4NDQzNzYsNTcuMTEzMDQzNSA0NC40NjI1NTQ3LDU3LjUzMDQzNDggTDQxLjI1OTMwMSw0My42ODY5NTY1IEMzOS4zNzkxMzAzLDQzLjY4Njk1NjUgMzYuNjI4NTEwMiw0OS41MzA0MzQ4IDM0Ljg4NzYxMTQsNTMuODQzNDc4MyBDMzEuODU4NDQ3Niw1MC45OTEzMDQzIDI5LjYzMDA5NzEsNDYuNjA4Njk1NyAyOS42MzAwOTcxLDQwLjkzOTEzMDQgQzI5LjYzMDA5NzEsMzMuOTgyNjA4NyAzMy4xMTE4OTQ3LDMwLjk1NjUyMTcgMzMuMTExODk0NywzMC45NTY1MjE3IEMzMy4xMTE4OTQ3LDMwLjk1NjUyMTcgMTkuOTE1ODgyLDMzLjE4MjYwODcgMTkuOTE1ODgyLDUyLjg2OTU2NTIgQzE5LjkxNTg4Miw1Ny41MzA0MzQ4IDIxLjQxMzA1NDksNjUuNTY1MjE3NCAyMS40MTMwNTQ5LDc0LjA4Njk1NjUgQzIxLjQxMzA1NDksODQuOTA0MzQ3OCAwLDk0LjkyMTczOTEgMCwxMjMuODI2MDg3IEMwLDE1NC43ODI2MDkgMTYuMDUxMDg2NywxNjggMTYuMDUxMDg2NywxNjggTDExNS4zNTE5NTMsMTY4IEMxMTUuMzUxOTUzLDE2OCAxNTQsMTQ4Ljk3MzkxMyAxNTQsOTkuNTEzMDQzNSBDMTU0LjAzNDcyNCw4MS42Njk1NjUyIDE0NC40MjQ5NjIsNzAuNzEzMDQzNSAxNDQuNDI0OTYyLDcwLjcxMzA0MzUgWiIvPgogICAgPHBhdGggZmlsbD0iI0YwNEUyMyIgZD0iTTExNywxMjguMzMxODY1IEMxMTAuODA3Nzc1LDEyOC4zMzE4NjUgMTAyLjA5MDIyOCwxMzguNjcxMjQ3IDEwMi4wOTAyMjgsMTM4LjY3MTI0NyBMMTEwLjQ2MTg0LDExMi45MDkyNDEgQzExMC40NjE4NCwxMTIuOTA5MjQxIDExMS44MTA5ODQsMTA1Ljg1NDk0NiAxMTEuODEwOTg0LDEwMC40MjU5MDYgQzExMS44MTA5ODQsODYuNjI4NTM2MSA5NS4yNzUzMjEsNzcuNjM3NzY4OCAxMDEuNjA1OTIsNzEuMzQ0MjMxNiBDOTIuOTIyOTY3Miw3MS4zNDQyMzE2IDkxLjAyMDMyODEsODcuNzAwNTEyMiA4NS40NTA3ODQ2LDg3LjcwMDUxMjIgQzg1LjQ1MDc4NDYsNjMuMjg3MTIwOSA3Ni4wNDEzNjk1LDQ3IDY4Ljg0NTkzNDQsNDcgQzYwLjE2Mjk4MTUsNDcgNDIuOTM1NDQ5NCw3NS41NjI5NzYzIDQyLjkzNTQ0OTQsODUuNzI5NDU5NCBDNDIuOTM1NDQ5NCw5NS44OTU5NDI1IDQ4LjEyNDQ2NSwxMDkuODMxNjMyIDQ1LjU2NDU1MDYsMTA5LjgzMTYzMiBDMzcuMjYyMTI1NSwxMDkuODMxNjMyIDMzLjM1MzA2Nyw4NC4yNzcxMDQ3IDI0Ljg0MzA4MTMsODQuMjc3MTA0NyBDMjkuMDk4MDc0Miw4OC41MzA0MjkyIDIwLDEwMy42NzY0MTQgMjAsMTIxLjAwMDkzMSBDMjAsMTM4LjAxNDIzIDI5LjI3MTA0MTQsMTQ1LjUxODA2MiAyOS4yNzEwNDE0LDE1Mi45NTI3MzUgQzI5LjA5ODA3NDIsMTU1LjUxMTY0NiA0Mi4wMDE0MjY1LDE1OC43NjIxNTQgNDIuMDAxNDI2NSwxNTUuODU3NDQ1IEM0Mi4wMDE0MjY1LDE1Mi45ODczMTUgMzcuMjI3NTMyMSwxNTIuNDY4NjE3IDM3LjIyNzUzMjEsMTQwLjc0NjA0IEMzNy4yMjc1MzIxLDEyOS4wMjM0NjIgMzIuMjgwNjcwNSwxMTcuMDkzNDA2IDI5LjQwOTQxNTEsMTE0LjIyMzI3NiBDMzUuODc4Mzg4LDExNC4yMjMyNzYgMzguNDM4MzAyNCwxMjcuMjk0NDY4IDU0LjEwOTEyOTgsMTI3LjI5NDQ2OCBDNjkuODE0NTUwNiwxMjcuMjk0NDY4IDYyLjM3Njk2MTUsMTEyLjczNjM0MSA2MC45OTMyMjQsMTA4LjAzMzQ3OCBDNTkuMjk4MTQ1NSwxMDIuMzI3Nzk5IDU3LjYzNzY2MDUsOTYuOTY3OTE4NiA1Ni43NzI4MjQ1LDkxLjA1NDc2IEM1Ni4zOTIyOTY3LDg4LjQ5NTg0OTMgNTcuMDE0OTc4Niw4Ni4xMDk4MzggNTguMjI1NzQ4OSw4My44Mjc1NjYzIEM2MC4yNjY3NjE4LDc5Ljk4OTIwMDIgNjIuNzkyMDgyNyw3Ni42MzQ5NTI0IDY1LjI0ODIxNjgsNzMuMDczMjI1MyBDNjcuMDQ3MDc1Niw3MC40Nzk3MzQ4IDY5LjIyNjQ2MjIsNjcuNjc4NzY0OSA3MC4yNjQyNjUzLDcxLjkzMjA4OTUgQzcwLjgxNzc2MDMsNzQuMjgzNTIwOSA3MC43ODMxNjY5LDc2LjY2OTUzMjMgNzAuOTU2MTM0MSw3OS4wNTU1NDM2IEM3MS4yMzI4ODE2LDgyLjc1NTU5MDIgNzEuNTc4ODE2LDg2LjQ5MDIxNjYgNzEuNTQ0MjIyNSw5MC4zOTc3NDI0IEM3MS41MDk2MjkxLDk3LjM0ODI5NzIgNzIuMzc0NDY1LDEwMy42MDcyNTQgNzQuNDUwMDcxMywxMTAuMjQ2NTkgQzc1LjQ1MzI4MSwxMTMuNDk3MDk5IDc5LjkxNTgzNDUsMTIzLjc2NzMyMSA4NC42NTUxMzU1LDEyMC4zNDM5MTQgQzg4LjM1NjYzMzQsMTE3LjY4MTI2MyA5Mi4xOTY1MDUsMTE0LjQ5OTkxNSA5Mi4xOTY1MDUsMTA5LjQ4NTgzMyBDOTIuMTk2NTA1LDk2Ljg2NDE3OSAxMDAuMjU2Nzc2LDk0LjI3MDY4ODQgMTAwLjI1Njc3Niw5NC4yNzA2ODg0IEMxMDAuMjU2Nzc2LDk0LjI3MDY4ODQgOTYuMTQwMTU2OSw5Ny45MDE1NzUyIDk2LjE0MDE1NjksMTEzLjk0NjYzNyBDOTYuMTQwMTU2OSwxMjEuMTczODMxIDkxLjUzOTIyOTcsMTI5LjAyMzQ2MiA4OS45ODI1MjUsMTM2LjI4NTIzNiBDODkuNzQwMzcwOSwxMzcuMzU3MjEyIDg2LjkzODMwMjQsMTUwLjk0NzEwMyA5MC4wODYzMDUzLDE0OS40MjU1ODggQzkyLjA1ODEzMTIsMTQ4LjQ5MTkzMiAxMDEuNDY3NTQ2LDE0Mi43ODYyNTIgMTAzLjQwNDc3OSwxNDQuNDQ2MDg2IEMxMDQuOTYxNDg0LDE0NS43OTQ3MDEgMTE2Ljc5MjQzOSwxNDUuNTg3MjIyIDExNi43OTI0MzksMTQwLjcxMTQ2IEMxMTYuNzkyNDM5LDEzNS44MzU2OTcgMTExLjc0MTc5NywxMzMuNjIyNTg1IDExNywxMjguMzMxODY1IFoiLz4KICAgIDxwYXRoIGZpbGw9IiMzMzJBMjciIGQ9Ik00OS4xNTA1MDg3LDEyMi41NDIxOTUgQzM1LjMwOTQ2NzUsMTIyLjU0MjE5NSAxOS42OTQ4MjU1LDE2Mi40Njk5MzggMTkuNjk0ODI1NSwxNjggTDExNi45OTk3MTksMTY4IEMxMTYuOTk5NzE5LDE2OCAxMTcuMDM0MjA4LDE2Ni4yMjYyMDcgMTE2LjMzODY3OSwxNjIuNDM1MTU4IEMxMTMuNjI2MTEzLDE0NS4yNTM3MDcgMTA3Ljk5MjMyMiwxMzIuMjQ1ODg4IDEwMC42ODkyNiwxMTcuNDk5MDU2IEMxMDAuNjg5MjYsMTEzLjYzODQ0NyA5Ni4yMzc4NywxMDYuNTQzMjczIDkzLjQ1NTc1MTIsMTA2LjU0MzI3MyBDOTMuNDU1NzUxMiwxMDYuNTQzMjczIDk0LjE4NjA1NzQsMTAzLjkzNDc1MyA5NC4xODYwNTc0LDEwMi41NDM1NDMgQzk0LjE4NjA1NzQsMTAwLjA3NDE0NCA5Mi40MTI0NTY2LDk5LjEwMDI5NjYgOTEuMjk5NjA5MSw5Ny45NTI1NDc5IEM5MC4xNTE5ODUxLDk2LjgwNDc5OTEgOTAuMjU2MzE0NSw5NC4xOTYyNzkzIDg4LjQxMzE2MDgsOTQuMTk2Mjc5MyBDODcuNjQ4MDc4MSw5NC4xOTYyNzkzIDg2LjQ2NTY3NzYsOTQuNjQ4NDIyOCA4Ni40NjU2Nzc2LDk0LjY0ODQyMjggQzg2LjQ2NTY3NzYsOTQuNjQ4NDIyOCA4NS45NDQwMzAzLDkwLjc1MzAzMzIgODcuNjEzMzAxNiw5MC43NTMwMzMyIEM5NS40MzgwMTA4LDkwLjc1MzAzMzIgMTEyLjAyNjM5NCwxMTQuMTI1MzcxIDExMi4wMjYzOTQsMTAzLjM3ODI2OSBDMTEyLjAyNjM5NCw5NS45MDA1MTIzIDEwNC44NjI0MzgsODYuMTI3MjU4IDk5Ljk5MzczMDQsODEuMjIzMjQwOCBDOTcuNDU1MDQ3LDc4LjY4NDI4MTUgOTEuMzY5MTYyMSw3NC4xMjgwNjY5IDkxLjM2OTE2MjEsNzQuMTI4MDY2OSBDOTEuMzY5MTYyMSw1NC44OTQ1ODA3IDc3LjcwMjAwMzMsNDAuMjUyMDg5NSA2My41NDc5NzM3LDQwLjI1MjA4OTUgQzUzLjkxNDg4NzIsNDAuMjUyMDg5NSA0Ny45MzMzMzE3LDQzLjY2MDU1NTQgNDcuOTMzMzMxNyw0My42NjA1NTU0IEM0Ni41NzcwNDg4LDQyLjMwNDEyNTEgNDcuNDgxMjM3NCwzOSA0NS4zNTk4NzE4LDM5IEM0My4zNDI4MzU2LDM5IDM0LjU0NDM4NDgsNDguOTgxOTM1OCAzNC41NDQzODQ4LDY0LjU5ODI3NDUgQzM0LjU0NDM4NDgsNjQuNTk4Mjc0NSAxNSw2Ni41ODA3NDk1IDE1LDcwLjQ3NjEzOTEgQzE1LDc1LjY1ODM5ODUgMzQuMjMxMzk2NSw3My4zMjgxMjA4IDM0LjIzMTM5NjUsNzYuODQwOTI3NSBDMzQuMjMxMzk2NSw3Ni44NDA5Mjc1IDM0LjAyMjczNzUsNzcuODg0MzM1NCAzNC4wMjI3Mzc1LDc5LjQxNDY2NyBDMzQuMDIyNzM3NSw4Mi41Nzk2NzExIDM1Ljg2NTg5MTMsODMuODMxNzYwNiAzNS44NjU4OTEzLDg1LjU3MDc3MzggQzM1Ljg2NTg5MTMsODYuMjY2Mzc5MSAzMS43Mjc0ODk1LDkwLjkyNjkzNDUgMzEuNzI3NDg5NSw5NS4yMzk2ODcyIEMzMS43Mjc0ODk1LDk4Ljc1MjQ5MzkgMzYuODM5NjMyOSw5Ni44NzQzNTk3IDM2LjgzOTYzMjksOTguMjMwNzkgQzM2LjgzOTYzMjksOTkuMDY1NTE2MyAzNi4wNzQ1NTAyLDEwMC40NTY3MjcgMzYuMDc0NTUwMiwxMDEuNzQzNTk3IEMzNi4wNzQ1NTAyLDEwMy4wMzA0NjYgMzguNTQzNjgwNywxMDMuMzA4NzA5IDM4LjU0MzY4MDcsMTAzLjMwODcwOSBDMzguNTQzNjgwNywxMDMuMzA4NzA5IDM3LjE4NzM5NzcsMTA0LjAwNDMxNCAzNy4xODczOTc3LDEwNC42NjUxMzkgQzM3LjE4NzM5NzcsMTA1LjMyNTk2NCAzNy42MDQ3MTU1LDEwNy4yMDQwOTggMzguNTc4NDU3MSwxMDcuMjA0MDk4IEM0MS4yNTYyNDY1LDEwNy4yMDQwOTggMzguNTQzNjgwNywxMTUuNDQ3MDIxIDQ0LjM4NjEzMDIsMTE1LjQ0NzAyMSBDNDUuNjcyODYwMiwxMTUuNDQ3MDIxIDQ5LjMyNDM5MTEsMTE0Ljg5MDUzNyA1MC43ODUwMDM1LDExNC44OTA1MzcgQzUyLjYyODE1NzMsMTE0Ljg5MDUzNyA1NC4yNjI2NTIxLDEyMi41NDIxOTUgNDkuMTUwNTA4NywxMjIuNTQyMTk1IFogTTM4LjAyMjAzMzQsNjQuNTk4Mjc0NSBDMzguMDIyMDMzNCw1NS44Njg0MjgxIDQxLjc3Nzg5MzgsNDcuNDg2Mzg0NSA0NC4yMTIyNDc4LDQ1LjA1MTc2NiBDNDQuMjEyMjQ3OCw1Mi44MDc3NjQ5IDQ3LjIwMzAyNTUsNjUuNzExMjQyOSA0Ny4yMDMwMjU1LDY1LjcxMTI0MjkgQzQ3LjIwMzAyNTUsNjUuNzExMjQyOSA0My4yMzg1MDYyLDY0LjU5ODI3NDUgMzguMDIyMDMzNCw2NC41OTgyNzQ1IFoiLz4KICA8L2c+Cjwvc3ZnPgo=");/g' /usr/share/kibana/src/legacy/ui/ui_render/views/ui_app.pug /usr/share/kibana/src/legacy/ui/ui_render/views/chrome.pug

# Custom HTML title information
RUN sed -i 's/title Kibana/title Dashboard/g' /usr/share/kibana/src/legacy/ui/ui_render/views/chrome.pug

# Fix to add perceniltes/percentile ranks back to gauge
RUN sed -i "s|'!std_dev', '!geo_centroid', '!percentiles', '!percentile_ranks',|'!std_dev', '!geo_centroid',|g" /usr/share/kibana/src/legacy/core_plugins/kbn_vislib_vis_types/public/gauge.js

# Custom css plugin
COPY --from=builder /custom_style.zip /usr/share/kibana/custom_style.zip
RUN sed -i 's/reverse()/reverse(),`${regularBundlePath}\/custom_style.style.css`/g' /usr/share/kibana/src/legacy/ui/ui_render/ui_render_mixin.js

# Modify logoKibana in vendorsDynamicDLL to be empty. Custom icon will be set as background-image in custom_style plugin css
RUN sed -i 's@var logoKibana=function.*logoKibana.defaultProps=@var logoKibana=function logoKibana(props){return _react.default.createElement("svg",props,_react.default.createElement("g",{fill:"none",fillRule:"evenodd"}))};logoKibana.defaultProps=@g' /usr/share/kibana/built_assets/dlls/vendors.bundle.dll.js

# Run script and config
COPY config/kibana.yml /usr/share/kibana/config/
COPY bin/docker-run.sh /usr/share/kibana/

# Plugins
RUN bin/kibana-plugin install file:///usr/share/kibana/custom_style.zip
RUN bin/kibana-plugin install file:///usr/share/kibana/${ROR_VERSION}
#RUN bin/kibana-plugin install https://github.com/datasweet/kibana-datasweet-formula/releases/download/v2.0.0/datasweet_formula-2.0.0_kibana-6.4.1.zip
# RUN bin/kibana-plugin install https://github.com/prelert/kibana-swimlane-vis/releases/download/v6.4.1/prelert_swimlane_vis-6.4.1.zip
RUN bin/kibana-plugin install https://github.com/fbaligand/kibana-enhanced-table/releases/download/v1.7.0/enhanced-table-1.7.0_7.5.1.zip

# Optimze frontend for quick stop up
RUN bin/kibana --optimize

CMD /usr/share/kibana/docker-run.sh

EXPOSE 5601

